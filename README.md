# 이미지 처리 모듈 서비스 


[🔗기존 프로젝트](https://github.com/4-Image-Module/Image-Module)


이 프로젝트는 이미지 처리 모듈로, 다양한 서버들이 협력하여 이미지를 효율적으로 처리하고 관리하는 시스템입니다.   
초기 프로젝트 기능 개선을 통해 성능과 안정성을 강화했습니다.




## 📍기획 의도 
이커머스 사이트에서는 수천에서 수만 개의 이미지를 사용하며, 이미지 처리 방식에 따라 시스템 성능과 비용에 큰 영향을 미칠 수 있습니다.<br>
따라서 효율적인 이미지 처리와 관리를 위해 CDN 서버를 직접 구현하여 이미지 조회와 업로드 성능을 향상시키고자 합니다.



## 📍 프로젝트 목표
1. Redis 활용: CDN 서버에서 이미지를 캐시하여 조회 성능을 향상시키고, 이미지 데이터의 빠른 접근을 가능하게 합니다.
2. Kafka 활용: 이미지 업로드를 비동기적으로 처리하여 성능을 향상시키고, 원본 이미지 및 리사이징 이미지를 효율적으로 업로드 서버로 전달하여 처리 시간을 단축시킵니다.

## ⚙️ 적용 기술
<img width="780" alt="기술 스택" src="https://github.com/user-attachments/assets/7ecff12a-3bdf-46ff-ba60-4020224089a1">


## 🏗️ 인프라 설계도

### 수정된 인프라 설계도 
<img width="800" alt="image" src="https://github.com/user-attachments/assets/92170bae-e731-4afd-ba69-b7e6d0ff54dc">


### 기존 인프라 설계도
<img width="780" alt="image" src="https://github.com/user-attachments/assets/a482a794-c114-43ce-9616-a65bf102678b">

## 🚀 주요 기능

### 1. Image Convert Server
- 매직넘버 확인으로 확장자 체크, 이미지 메타데이터 제거, 이미지 JPEG 파일 변환, 이미지 캐싱 처리 <br>이미지 정보 Kafka로 upload , resize 서버에 전달 

### 2. Image Upload Server
- 이미지 Minio에 업로드
- 이미지 정보 DB 저장 요청 (원본 이름, 확장자 등)

### 3. Image Resizing Server
- 이미지 리사이징
- 리사이징된 이미지 정보 DB 저장 요청 
- 리사이징 이미지 Minio에 업로드

### 4. CDN Server
- 브라우저의 이미지 조회 요청 처리
- 이미지 캐싱 처리

### 5. Data Server
- 이미지 정보 DB 저장
- CDN URL 생성


## 🛠️ 이미지 처리 시스템 개선 사항

| **Modification**                                 | **Details**                                                                 |
|--------------------------------------------------|-----------------------------------------------------------------------------|
| **JPEG 압축**                                    | WebP 대신 JPEG 형식으로 이미지를 압축, JPEG는 메타데이터 제거가 가능<br> |
| **변환 서버 도입**                               | 업로드 전에 변환 서버에서 메타데이터 제거 및 JPEG 변환 수행<br>           |
| **Redis 캐싱**                                   | 이미지 데이터를 Redis에 캐싱하여 리사이징 서버가 MinIO 대신 Redis에서 이미지를 가져올 수 있도록 설정<br> |
| **리사이징 이미지 데이터 분리 저장**             | 리사이징된 이미지 데이터를 별도의 테이블에 저장하여 확장성 개선<br>         |
| **매직 넘버 검증**                                | 파일 확장자 대신 매직 넘버를 사용하여 이미지 파일의 유효성 검증<br>        |
| **Kafka를 이용한 업로드 상태 모니터링**          | 업로드 상태를 실시간 모니터링하고 실패 시 재시도<br>                       |
| **CDN 직접 접근**                               | URL 서버를 제거하고, CDN이 데이터 서버에 직접 접근하여 이미지를 조회<br> |
| **이미지 조회시 파일시스템 다운로드 제거**       | redis에 cdn url 과 이미지 바이트를 저장, redis에 이미지 없을 시, Minio에서 조회<br> |
| **고화질 원본 이미지 최적화**                    | 압축된 원본 이미지와 리사이징 이미지는 MinIO에 저장, 고화질 원본 이미지는 별도 클라우드 스토리지에 저장<br> |



# 🚀 업로드 개선 결과 

### **성능 향상 요인**
- **이미지 압축**<br>이미지 업로드 전 압축을 통해 업로드 시간과 Minio 비용 효율성을 증가시켰습니다.
- **Minio 서버 접근 최소화**<br> 이미지 변환, 리사이징, 메타데이터 제거 등의 과정에서 불필요한 Minio 접근을 Redis 캐싱으로 대체하여 업로드 처리 시간을 감소시켰습니다.
- **Kafka 비동기 실행**<br> Kafka를 통해 변환된 이미지 정보를 전달하고, 원본 업로드와 리사이징 업로드가 **비동기적으로** 실행되도록 했습니다.

### **성능 개선 전**
- **업로드 시간**: 1077ms  
  동일한 이미지를 업로드하는 데 **1077ms**가 소요되었습니다.

### **성능 개선 후**
- **업로드 시간**: 580ms  
  성능 개선 후 동일한 이미지를 업로드하는 데 **580ms**가 소요되었습니다.

### **성능 개선 비율**
- 업로드 시간은 **약 46%** 향상되었습니다.

![업로드 개선](https://github.com/user-attachments/assets/330a32a9-9451-4e19-828f-821ccd83c326)



---

# 📊 조회 성능 개선 결과

### **성능 향상 요인**
- **레디스 캐싱 방식 변경** <br>이전에는 파일을 다운로드하고 Redis에 CDN URL 경로를 저장하는 방식이었으나, 이는 용량을 차지하고 성능 저하를 일으켰습니다. <br>개선 후, 이미지 조회 시 Redis에 데이터가 없으면 Minio에서 조회한 후 Redis에 CDN URL과 이미지를 저장하여 성능을 향상시켰습니다.

### 성능 개선 전



- **기존**: 이미지 조회 시 파일을 다운로드하고 Redis에 경로를 저장하는 방식으로 성능 저하.
- **기존 성능 캐싱 전** 조회 시간: **534ms**
- **기존 성능 캐싱 후** 조회 시간: **273ms**
- **성능 개선 전 캐싱 전 개선률**: 약 **48.88%** 향상

![기존 성능](https://github.com/user-attachments/assets/7e89c8fa-68ef-4b4f-b6b8-7ed7360ada07)

### 성능 개선 후



- **개선 후**: 이미지 데이터를 **Redis에 캐시**하여 조회 속도를 개선, **응답 시간**이 대폭 단축되었습니다.
- **성능 개선 후 캐싱 전** 조회 시간: **212ms**
- **성능 개선 후 캐싱 후** 조회 시간: **8ms**
- **성능 개선 후 개선률 비율**: 약 **96.23%** 향상

![성능 개선 후](https://github.com/user-attachments/assets/67b732f2-fdee-4c08-95da-78e3d55914c7)



---

# 📉 MinIO 접근 횟수 최적화

- **기존**: 이미지 변환 및 리사이징 작업 중 **MinIO**에 **5회** 접근이 발생하여 성능 저하.
- **개선 후**: 이미지 변환 및 메타데이터 제거 과정을 **업로드 전**에 처리하고, **Redis**에서 캐시된 이미지를 사용하여 MinIO 접근을 **1회**로 감소.
  - **기존** MinIO 접근 횟수: **5회**
  - **개선 후** MinIO 접근 횟수: **1회**
  - **성능 향상**: **80%** 접근 횟수 감소.

---



**이 프로젝트**는 최적화된 이미지 관리로 사용자 경험을 개선하고, 안정적인 데이터 처리를 통해 이커머스 회사 내부에서 효율적인 이미지 처리를 제공합니다. 📈
