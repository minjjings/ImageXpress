# 이미지 처리 모듈 서비스 / 프로젝트 소개

**이커머스 이미지 관련 처리를 돕기 위한 B2B 이미지 처리 모듈**

## 📍기획 의도 
- 이커머스 사이트는 평균적으로 수천개에서 수만개의 이미지를 사용
- 이미지 처리 방식에 따라 성능과 비용에 영향

## 📍 프로젝트 목표
- 조회 성능 향상하여 긍적적인 사용자 경험
- Minio 접근을 줄여 비용 절감

## 🏗️ 인프라 설계도

### 수정된 인프라 설계도 
<img width="1000" alt="image" src="https://github.com/user-attachments/assets/10fd0b42-17c8-4fe2-b7a1-12d4c62de1d2">

### 기존 인프라 설계도
![기존 설계도](https://github.com/user-attachments/assets/a482a794-c114-43ce-9616-a65bf102678b)

## 🚀 주요 기능

### 1. Image Convert Server
- 매직넘버 확인으로 확장자 체크
- 이미지 메타데이터 제거
- 이미지 JPEG 파일 변환
- 이미지 캐싱 처리
- 이미지 정보 Kafka로 upload , resize 서버에 전달 

### 2. Image Upload Server
- 이미지 Minio에 업로드
- 이미지 정보 DB 저장 요청 (원본 이름, 확장자 등)

### 3. Image Resizing Server
- 이미지 리사이징
- 리사이징된 이미지 정보 DB 저장 요청 
- 리사이징 이미지 Minio에 업로드

### 4. CDN Server
- 브라우저의 이미지 조회 요청 처리
- 이미지 캐싱 처리

### 5. Data Server
- 이미지 정보 DB 저장
- CDN URL 생성


## ⚙️ 적용 기술

![기술 스택](https://github.com/user-attachments/assets/7ecff12a-3bdf-46ff-ba60-4020224089a1)


## 🛠️ 이미지 처리 시스템 개선 사항

### 1. CDN 조회 방식 개선
- **개선해야 할 사항**: 이미지 조회 시, 파일로 다운로드 후 레디스에 key와 파일 경로 저장
- **개선 방안**: 레디스 key에 URL과 byte 배열로 이미지를 저장하여 과정 단순화
- **개선 결과**:
  - 성능 향상 및 데이터 처리 간소화
  - 데이터 일관성 보장
  - 불필요한 복잡한 로직 제거

### 2. 업로드 상태 모니터링 개선
- **개선해야 할 사항**: 현재 SSE 방식을 사용하여 업로드 상태를 알 수 있으나, 업로드 실패 시 재시도가 불가능
- **개선 방안**: 업로드 상태를 실시간으로 모니터링하고, 업로드 실패 시 재시도 가능하도록 Kafka 사용
- **개선 결과**:
  - 실시간 업로드 상태 모니터링 가능 📊
  - 업로드 실패 시 재시도 로직 추가 🔄

### 3. MinIO 접근 횟수 최적화
- **개선해야 할 사항**: 원본 이미지 업로드 후 변환 및 리사이징 작업 중 5회의 MinIO 접근 발생
- **개선 방안**: 이미지 변환 및 메타데이터 제거 업로드 전 동작, 캐시 처리로 minio 접근하지 않고 redis로 접근 
- **개선 결과**:
  - MinIO 접근 횟수 감소 📉
  - 캐시 처리로 효율성 증가 ⚡

### 4. 데이터 검증
- **개선해야 할 사항**: 이상한 데이터 접근을 감지할 필요 있음
- **개선 방안**: 데이터 접근 및 변환 과정에서 이상 데이터를 감지하는 로직 추가 , 매직넘버 확인 
- **개선 결과**:
  - 시스템 안정성 향상 🔐
  - 데이터 처리 안정성 보장 🛡️


## 🔧 수정 상세 내용

- **JPEG 압축**: WebP 대신 JPEG 형식으로 이미지를 압축, JPEG는 메타데이터 제거가 가능
- **변환 서버 도입**: 업로드 전에 변환 서버에서 메타데이터 제거 및 JPEG 변환 수행
- **Redis 캐싱**: 이미지 데이터를 Redis에 캐싱하여 리사이징 서버가 MinIO 대신 Redis에서 이미지를 가져올 수 있도록 설정
- **리사이징 이미지 데이터 분리 저장**: 리사이징된 이미지 데이터를 별도의 테이블에 저장하여 확장성 개선
- **매직 넘버 검증**: 파일 확장자 대신 매직 넘버를 사용하여 이미지 파일의 유효성 검증
- **Kafka를 이용한 업로드 상태 모니터링**: 업로드 상태를 실시간 모니터링하고 실패 시 재시도
- **CDN 직접 접근**: URL 서버를 제거하고, CDN이 데이터 서버에 직접 접근하여 이미지를 조회
- **이미지 조회시 파일시스템 다운로드 제거** : redis에 cdn url 과 이미지 바이트를 저장 , redis에 이미지 없을 시 , Minio에서 조회 
- **고화질 원본 이미지 최적화**: 압축된 원본 이미지와 리사이징 이미지는 MinIO에 저장, 고화질 원본 이미지는 별도 클라우드 스토리지에 저장


## 🚀 업로드 개선 결과
<img width="800" alt="image" src="https://github.com/user-attachments/assets/330a32a9-9451-4e19-828f-821ccd83c326">

### **성능 개선 전**
- **업로드 시간**: 1077ms  
- 동일한 이미지를 업로드하는 데 **1077ms**가 소요되었습니다.

### **성능 개선 후**
- **업로드 시간**: 580ms  
- 성능 개선 후 동일한 이미지를 업로드하는 데 **580ms**가 소요되었습니다.

### **성능 개선 비율**
- 업로드 시간은 **약 46%** 향상되었습니다.

### **성능 향상 요인**
- **이미지 압축**: 이미지 업로드 전, 이미지 압축으로 업로드 시간과 Minio 비용의 효율성을 증가시켰습니다.
- **Minio 서버 접근 최소화**: 이미지 변환, 리사이징, 메타데이터 제거 등의 과정에서 불필요한 Minio 접근을 Redis 캐싱의 사용으로 업로드 처리 시간을 감소시켰습니다.


## 📊 **조회 성능 개선 결과**


### 성능 개선 전후

### 기존 성능

<img width="280" alt="image" src="https://github.com/user-attachments/assets/7e89c8fa-68ef-4b4f-b6b8-7ed7360ada07">
  
- **기존**: 이미지 조회 시, 파일을 다운로드하고 Redis에 경로를 저장하는 방식으로 성능 저하.
- **기존 성능 캐싱 전** 조회 시간: **534ms**
- **기존 성능 캐싱 후** 조회 시간: **273ms**
- **성능 개선 전 캐싱 전 개선률**: 약 **48.88%** 향상

### 성능 개선 후
<img width="800" alt="image" src="https://github.com/user-attachments/assets/67b732f2-fdee-4c08-95da-78e3d55914c7">

- **개선 후**: 이미지 데이터를 **Redis에 캐시**하여 조회 속도를 개선, **응답 시간**이 대폭 단축되었습니다.
- **성능 개선 후 캐싱 전** 조회 시간: **212ms**
- **성능 개선 후 캐싱 후** 조회 시간: **8ms**
- **성능 개선 후 개선률 비율**: 약 **96.23%** 향상




## 📉 **MinIO 접근 횟수 최적화**
- **기존**: 이미지 변환 및 리사이징 작업 중 **MinIO**에 **5회** 접근이 발생하여 성능 저하.
- **개선 후**: 이미지 변환 및 메타데이터 제거 과정을 **업로드 전**에 처리하고, **Redis**에서 캐시된 이미지를 사용하여 MinIO 접근을 **1회**로 감소.
  - **기존** MinIO 접근 횟수: **5회**
  - **개선 후** MinIO 접근 횟수: **1회**
  - **성능 향상**: **80%** 접근 횟수 감소.




---

**이 프로젝트**는 최적화된 이미지 관리로 사용자 경험을 개선하고, 안정적인 데이터 처리를 통해 이커머스 회사 내부에서 효율적인 이미지 처리를 제공합니다. 📈
